name: Lighthouse CI

on:
  pull_request:
    branches: [ develop ]
    types: [ opened, reopened, synchronize ]
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: yarn install

      - name: Install Lighthouse CI
        run: yarn global add @lhci/cli

      - name: Run Lighthouse CI (No Fail on Defaults)
        run: lhci autorun --collect.url="https://argos.co.uk" --upload.target=filesystem --upload.outputDir='.lighthouseci' || echo "Lighthouse completed with warnings"

      - name: Debug Lighthouse Output
        run: ls -la .lighthouseci || echo "No reports found!"

      - name: Upload Lighthouse Report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          include-hidden-files: true
          path: .lighthouseci/**/*

      - name: Comment on PR with Lighthouse Scores
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            🚦 **Lighthouse Audit Results**
            - 🏎️ Performance: **$(jq '.categories.performance.score' .lighthouseci/manifest.json)**
            - 🛠️ Accessibility: **$(jq '.categories.accessibility.score' .lighthouseci/manifest.json)**
            - 🔍 SEO: **$(jq '.categories.seo.score' .lighthouseci/manifest.json)**
