name: Lighthouse CI

on:
  pull_request:
    branches: [ develop ]
    types: [ opened, reopened, synchronize ]
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check jq Installation
        run: jq --version

      - name: Install Dependencies
        run: yarn install

      - name: Install Lighthouse CI
        run: yarn global add @lhci/cli

      - name: Set Dynamic URL
        run: echo "TEST_URL=https://argos.co.uk" >> $GITHUB_ENV

      - name: Run Lighthouse CI (No Fail on Defaults)
        run: lhci autorun
        env:
          TEST_URL: ${{ env.TEST_URL }}

      - name: Debug Lighthouse Output
        run: ls -la .lighthouseci || echo "No reports found!"

      - name: Upload Lighthouse Report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          include-hidden-files: true
          path: .lighthouseci/**/*

      - name: Comment on PR with Lighthouse Scores
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ğŸš¦ **Lighthouse Audit Results**
            - ğŸï¸ Performance: **$(jq '.categories.performance.score' .lighthouseci/manifest.json)**
            - ğŸ› ï¸ Accessibility: **$(jq '.categories.accessibility.score' .lighthouseci/manifest.json)**
            - ğŸ” SEO: **$(jq '.categories.seo.score' .lighthouseci/manifest.json)**
