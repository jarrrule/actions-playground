name: Lighthouse CI

on:
  push:
    branches: [ lighthouse ]
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: yarn install

      - name: Install Lighthouse CI
        run: yarn global add @lhci/cli

      - name: Run Lighthouse on Preview Deployment
        run: lhci autorun --collect.url="https://bbc.com"

      - name: Upload Lighthouse Report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci/

      - name: Comment on PR with Lighthouse Scores
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ğŸš¦ **Lighthouse Audit Results**
            - ğŸï¸ Performance: **$(jq '.categories.performance.score' .lighthouseci/manifest.json)**
            - ğŸ› ï¸ Accessibility: **$(jq '.categories.accessibility.score' .lighthouseci/manifest.json)**
            - ğŸ” SEO: **$(jq '.categories.seo.score' .lighthouseci/manifest.json)**
